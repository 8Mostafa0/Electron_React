"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const plugin_retry_1 = require("@octokit/plugin-retry");
const rest_1 = require("@octokit/rest");
const debug_1 = __importDefault(require("debug"));
const logInfo = (0, debug_1.default)('electron-forge:publisher:github:info');
const logDebug = (0, debug_1.default)('electron-forge:publisher:github:debug');
class GitHub {
    constructor(authToken = undefined, requireAuth = false, options = {}) {
        const noOp = () => {
            /* Intentionally does nothing */
        };
        this.options = {
            ...options,
            log: {
                debug: logDebug.enabled ? logDebug : noOp,
                error: console.error,
                info: logInfo.enabled ? logInfo : noOp,
                warn: console.warn,
            },
            userAgent: 'Electron Forge',
        };
        if (authToken) {
            this.token = authToken;
        }
        else if (process.env.GITHUB_TOKEN) {
            this.token = process.env.GITHUB_TOKEN;
        }
        else if (requireAuth) {
            throw new Error('Please set GITHUB_TOKEN in your environment to access these features');
        }
    }
    getGitHub() {
        const options = { ...this.options };
        if (this.token) {
            options.auth = this.token;
        }
        const RetryableOctokit = rest_1.Octokit.plugin(plugin_retry_1.retry);
        const github = new RetryableOctokit(options);
        return github;
    }
    // Based on https://github.com/cli/cli/blob/b07f955c23fb54c400b169d39255569e240b324e/pkg/cmd/release/upload/upload.go#L131-L153
    static sanitizeName(name) {
        return (path_1.default
            .basename(name)
            // Remove diacritics (e.g. Ã© -> e)
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu, '')
            // Replace special characters with dot
            .replace(/[^\w_.@+-]+/g, '.')
            // Replace multiple dots with a single dot
            .replace(/\.+/g, '.')
            // Remove leading dot if present
            .replace(/^\./g, '')
            // Remove trailing dot if present
            .replace(/\.$/g, ''));
    }
}
exports.default = GitHub;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0aHViLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvZ2l0aHViLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBR3hCLHdEQUE4QztBQUM5Qyx3Q0FBd0M7QUFDeEMsa0RBQTBCO0FBRTFCLE1BQU0sT0FBTyxHQUFHLElBQUEsZUFBSyxFQUFDLHNDQUFzQyxDQUFDLENBQUM7QUFDOUQsTUFBTSxRQUFRLEdBQUcsSUFBQSxlQUFLLEVBQUMsdUNBQXVDLENBQUMsQ0FBQztBQUVoRSxNQUFxQixNQUFNO0lBS3pCLFlBQVksWUFBZ0MsU0FBUyxFQUFFLFdBQVcsR0FBRyxLQUFLLEVBQUUsVUFBMEIsRUFBRTtRQUN0RyxNQUFNLElBQUksR0FBRyxHQUFHLEVBQUU7WUFDaEIsZ0NBQWdDO1FBQ2xDLENBQUMsQ0FBQztRQUVGLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixHQUFHLE9BQU87WUFDVixHQUFHLEVBQUU7Z0JBQ0gsS0FBSyxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSTtnQkFDekMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO2dCQUNwQixJQUFJLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJO2dCQUN0QyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7YUFDbkI7WUFDRCxTQUFTLEVBQUUsZ0JBQWdCO1NBQzVCLENBQUM7UUFFRixJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO1NBQ3hCO2FBQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO1NBQ3ZDO2FBQU0sSUFBSSxXQUFXLEVBQUU7WUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxzRUFBc0UsQ0FBQyxDQUFDO1NBQ3pGO0lBQ0gsQ0FBQztJQUVELFNBQVM7UUFDUCxNQUFNLE9BQU8sR0FBbUIsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNwRCxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7U0FDM0I7UUFDRCxNQUFNLGdCQUFnQixHQUFHLGNBQU8sQ0FBQyxNQUFNLENBQUMsb0JBQUssQ0FBQyxDQUFDO1FBQy9DLE1BQU0sTUFBTSxHQUFHLElBQUksZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0MsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELCtIQUErSDtJQUMvSCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQVk7UUFDOUIsT0FBTyxDQUNMLGNBQUk7YUFDRCxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2Ysa0NBQWtDO2FBQ2pDLFNBQVMsQ0FBQyxLQUFLLENBQUM7YUFDaEIsT0FBTyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQztZQUMvQixzQ0FBc0M7YUFDckMsT0FBTyxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUM7WUFDN0IsMENBQTBDO2FBQ3pDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDO1lBQ3JCLGdDQUFnQzthQUMvQixPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztZQUNwQixpQ0FBaUM7YUFDaEMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FDdkIsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTFERCx5QkEwREMifQ==